<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R√©ception chantier ‚Äì Lampadaires solaires</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #f6f7f9; }
    header { padding: 16px; background: #111827; color: white; }
    main { padding: 16px; max-width: 980px; margin: 0 auto; }

    .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    /* Style pour les points li√©s (1.1, 1.2...) */
    .card.linked { margin-left: 30px; border-left: 4px solid #2563eb; background: #f9fafb; }
    
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 720px){ .row { grid-template-columns: 1fr; } }

    label { display: block; font-size: 12px; color: #374151; margin-bottom: 4px; }
    input, select, textarea, button {
      width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #d1d5db; background: #fff;
      font-size: 14px; box-sizing: border-box;
    }
    textarea { min-height: 70px; resize: vertical; }

    .btnrow { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .btn { cursor:pointer; border: 0; background:#111827; color:white; padding:10px 12px; border-radius:10px; width:auto; }
    .btn.secondary { background:#374151; }
    .btn.danger { background:#b91c1c; }

    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; }
    .bad { background:#fee2e2; color:#991b1b; }

    .point-head { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap: wrap; }
    .small { font-size:12px; color:#6b7280; }

    .photos { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .thumb { width:110px; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff; }
    .thumb img { display:block; width:100%; height:80px; object-fit:cover; }
    .thumb div { font-size:11px; padding:6px; color:#374151; }

    #pdfLoading {
      position: fixed; inset: 0; background: rgba(17,24,39,.85); color: white;
      display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    #pdfLoading .spinner {
      width: 42px; height: 42px; border: 4px solid rgba(255,255,255,.3);
      border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
<header>
  <div style="max-width:980px;margin:0 auto; display:flex; align-items:center; gap:14px;">
    <img src="logo.png" alt="Logo" style="height:48px; object-fit:contain;" />
    <div>
      <div style="font-weight:700;">R√©ception de chantier</div>
      <div class="small">Fiche des points non conformes</div>
    </div>
  </div>
</header>

<main>
  <section class="card" id="chantierCard">
    <h3 style="margin:0 0 10px 0;">1) Infos chantier</h3>
    <div class="row">
      <div><label>Projet / Affaire</label><input id="projet" placeholder="Ex: EP - Commune X" /></div>
      <div><label>Commune</label><input id="commune" placeholder="Ex: N√©rac" /></div>
      <div><label>Adresse / Zone</label><input id="zone" placeholder="Rue..." /></div>
      <div><label>Date</label><input id="date" type="date" /></div>
      <div>
        <label>Poseur</label>
        <select id="poseur">
          <option value="">‚Äî S√©lectionner ‚Äî</option>
          <option value="ELECTROMONTAGE">ELECTROMONTAGE</option>
          <option value="SPIE">SPIE</option>
          <option value="BYES">BYES</option>
          <option value="INEO">INEO</option>
          <option value="__autre__">Autre‚Ä¶</option>
        </select>
      </div>
      <div id="poseurAutreWrap" style="display:none;"><label>Nom poseur</label><input id="poseurAutre" /></div>
      <div><label>Chef d‚Äô√©quipe</label><input id="chef" /></div>
      <div>
        <label>Contr√¥leur</label>
        <select id="controleur">
          <option value="">‚Äî S√©lectionner ‚Äî</option>
          <option value="Neals Volante">Neals Volante</option>
          <option value="Tony Diniz">Tony Diniz</option>
          <option value="Quentin Gobbato">Quentin Gobbato</option>
          <option value="Virgil Delbrel">Virgil Delbrel</option>
          <option value="__autre__">Autre‚Ä¶</option>
        </select>
      </div>
      <div id="controleurAutreWrap" style="display:none;"><label>Nom contr√¥leur</label><input id="controleurAutre" /></div>
    </div>

    <div class="row" style="margin-top:12px; border-top:1px solid #eee; padding-top:12px;">
      <div><label>üìÇ Mes fiches</label><select id="ficheSelect"></select></div>
      <div>
        <label>Actions fiche</label>
        <div class="btnrow">
          <button class="btn secondary" id="newFicheBtn">‚ûï Nouvelle</button>
          <button class="btn" id="saveFicheBtn">üíæ Sauver</button>
          <button class="btn secondary" id="dupFicheBtn">üìÑ Dupliquer</button>
          <button class="btn danger" id="delFicheBtn">üóëÔ∏è Supprimer</button>
        </div>
      </div>
    </div>

    <div class="btnrow" style="margin-top:12px;">
      <button class="btn" id="addPointBtn">‚ûï Ajouter un point principal</button>
      <button class="btn secondary" id="pdfBtn">üßæ Exporter PDF</button>
      <button class="btn" id="sharePdfBtn" style="background:#2563eb;">üì§ Partager (Mail/WA)</button>
      <button class="btn danger" id="resetBtn">üßΩ Vider la fiche</button>
    </div>
  </section>

  <section id="pointsWrap"></section>

  <section class="card" id="syntheseCard">
    <h3 style="margin:0 0 10px 0;">2) Synth√®se & Signatures</h3>
    <div id="syntheseText" class="small" style="margin-bottom:12px;"></div>
    <div class="row">
      <div>
        <label>Contr√¥leur</label>
        <canvas id="sigControleur" width="420" height="160" style="border:1px solid #ddd; background:#fff; touch-action:none; width:100%; border-radius:10px;"></canvas>
        <button class="btn danger" id="clearSigControleur" style="margin-top:5px;">Effacer</button>
      </div>
      <div>
        <label>Entreprise</label>
        <canvas id="sigEntreprise" width="420" height="160" style="border:1px solid #ddd; background:#fff; touch-action:none; width:100%; border-radius:10px;"></canvas>
        <button class="btn danger" id="clearSigEntreprise" style="margin-top:5px;">Effacer</button>
      </div>
      <div>
        <label>Client</label>
        <canvas id="sigClient" width="420" height="160" style="border:1px solid #ddd; background:#fff; touch-action:none; width:100%; border-radius:10px;"></canvas>
        <button class="btn danger" id="clearSigClient" style="margin-top:5px;">Effacer</button>
      </div>
    </div>
  </section>
</main>

<div id="pdfLoading"><div class="box"><div class="spinner"></div><div>G√©n√©ration du PDF‚Ä¶</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* =========================
   STOCKAGE & CONFIG
========================= */
const DB_NAME = "reception_v1", DB_STORE = "photos", FICHES_INDEX_KEY = "FL_INDEX", CURRENT_FICHE_KEY = "FL_CURRENT";
const byId = (id) => document.getElementById(id);
const newId = (prefix="id") => `${prefix}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;
const todayISO = () => new Date().toISOString().split('T')[0];
const escapeHtml = (str) => String(str ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));

/* ===== IndexedDB ===== */
const openDB = () => new Promise((resolve) => {
  const req = indexedDB.open(DB_NAME, 1);
  req.onupgradeneeded = () => { const db = req.result; if (!db.objectStoreNames.contains(DB_STORE)) { const s = db.createObjectStore(DB_STORE, { keyPath: "id" }); s.createIndex("pointId", "pointId", { unique:false }); }};
  req.onsuccess = () => resolve(req.result);
});
const idbPut = async (obj) => { const db = await openDB(); const tx = db.transaction(DB_STORE, "readwrite"); tx.objectStore(DB_STORE).put(obj); return new Promise(r => tx.oncomplete = () => { db.close(); r(); }); };
const idbGetPhotos = async (pid) => { const db = await openDB(); const tx = db.transaction(DB_STORE, "readonly"); const req = tx.objectStore(DB_STORE).index("pointId").getAll(pid); return new Promise(r => req.onsuccess = () => { db.close(); r(req.result || []); }); };
const idbDelete = async (id) => { const db = await openDB(); const tx = db.transaction(DB_STORE, "readwrite"); tx.objectStore(DB_STORE).delete(id); return new Promise(r => tx.oncomplete = () => { db.close(); r(); }); };

/* ===== Logique Points ===== */
const defaultPoint = (parentId = null) => ({ 
  id: newId("pt"), numero: "", repere: "", lat: "", lon: "", reserves_txt: "", date_reprise: "", parentId: parentId 
});

let state = { chantier: { projet:"", commune:"", zone:"", date:todayISO(), poseur:"", poseurAutre:"", chef:"", controleur:"", controleurAutre:"", signatures:{} }, points: [defaultPoint()] };

const loadFichesIndex = () => JSON.parse(localStorage.getItem(FICHES_INDEX_KEY) || "[]");
const saveFichesIndex = (idx) => localStorage.setItem(FICHES_INDEX_KEY, JSON.stringify(idx));
const getCurrentFicheId = () => localStorage.getItem(CURRENT_FICHE_KEY);

const saveCurrentFiche = () => {
  const id = getCurrentFicheId(); if (!id) return;
  localStorage.setItem(`FICHE_${id}`, JSON.stringify(state));
  const idx = loadFichesIndex();
  const name = `${state.chantier.projet || 'Nouveau'} - ${state.chantier.commune || ''}`.trim();
  const next = idx.map(f => f.id === id ? { ...f, name, updatedAt: Date.now() } : f);
  saveFichesIndex(next);
};

/* ===== Rendu Interface ===== */
const renderPoint = (p, label, photos) => `
  <section class="card ${p.parentId ? 'linked' : ''}" data-point-id="${p.id}">
    <div class="point-head">
      <div><strong>Point ${label}</strong> <span class="pill bad">Non conforme</span></div>
      <div class="btnrow">
        <button class="btn secondary" data-action="gps">üìç GPS</button>
        ${!p.parentId ? `<button class="btn" style="background:#2563eb;" data-action="add-linked">‚ûï Luminaire li√©</button>` : ''}
        <button class="btn danger" data-action="remove">üóëÔ∏è</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div><label>N¬∞ point lumineux</label><input style="${p.numero?'':'border:2px solid red'}" value="${escapeHtml(p.numero)}" data-k="numero" /></div>
      <div><label>Rep√®re / Adresse</label><input value="${escapeHtml(p.repere)}" data-k="repere" /></div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div><label>Lat</label><input value="${escapeHtml(p.lat)}" data-k="lat" readonly /></div>
      <div><label>Lon</label><input value="${escapeHtml(p.lon)}" data-k="lon" readonly /></div>
    </div>
    <textarea style="margin-top:10px;" data-k="reserves_txt" placeholder="Observations...">${escapeHtml(p.reserves_txt)}</textarea>
    <div style="margin-top:10px;">
      <input type="file" accept="image/*" multiple data-action="addPhotos" />
      <div class="photos">${photos.map(ph => `<div class="thumb"><img src="${ph.dataUrl}" /><button class="btn danger" style="padding:2px; width:100%; font-size:10px;" data-action="rmPhoto" data-photo-id="${ph.id}">Suppr.</button></div>`).join("")}</div>
    </div>
  </section>`;

const render = async () => {
  const c = state.chantier;
  byId("projet").value = c.projet; byId("commune").value = c.commune; byId("date").value = c.date; byId("poseur").value = c.poseur;
  byId("controleur").value = c.controleur;
  
  const chunks = [];
  const mains = state.points.filter(p => !p.parentId);
  for (let i=0; i < mains.length; i++) {
    const m = mains[i];
    chunks.push(await renderPoint(m, i+1, await idbGetPhotos(m.id)));
    const linked = state.points.filter(p => p.parentId === m.id);
    for (let j=0; j < linked.length; j++) {
      chunks.push(await renderPoint(linked[j], `${i+1}.${j+1}`, await idbGetPhotos(linked[j].id)));
    }
  }
  byId("pointsWrap").innerHTML = chunks.join("");
  byId("syntheseText").innerHTML = `Total : ${state.points.length} r√©serves.`;
};

/* ===== Events ===== */
const handleEvents = () => {
  byId("addPointBtn").onclick = () => { state.points.push(defaultPoint()); render(); saveCurrentFiche(); };
  
  byId("pointsWrap").onclick = async (e) => {
    const btn = e.target.closest("button"); if (!btn) return;
    const pid = btn.closest("[data-point-id]").dataset.pointId;
    const action = btn.dataset.action;

    if (action === "gps") navigator.geolocation.getCurrentPosition(pos => {
      const p = state.points.find(x => x.id === pid);
      p.lat = pos.coords.latitude.toFixed(6); p.lon = pos.coords.longitude.toFixed(6);
      render(); saveCurrentFiche();
    });

    if (action === "add-linked") {
      const parent = state.points.find(x => x.id === pid);
      const child = defaultPoint(parent.id);
      child.reserves_txt = parent.reserves_txt; child.repere = parent.repere;
      state.points.push(child); render(); saveCurrentFiche();
    }

    if (action === "remove") {
      if (confirm("Supprimer ce point ?")) {
        state.points = state.points.filter(x => x.id !== pid && x.parentId !== pid);
        render(); saveCurrentFiche();
      }
    }

    if (action === "rmPhoto") { await idbDelete(btn.dataset.photoId); render(); }
  };

  byId("pointsWrap").oninput = (e) => {
    const k = e.target.dataset.k; if (!k) return;
    const pid = e.target.closest("[data-point-id]").dataset.pointId;
    state.points.find(x => x.id === pid)[k] = e.target.value;
    saveCurrentFiche();
  };

  byId("pointsWrap").onchange = async (e) => {
    if (e.target.dataset.action === "addPhotos") {
      const pid = e.target.closest("[data-point-id]").dataset.pointId;
      for (const f of e.target.files) {
        const reader = new FileReader();
        reader.onload = async (ev) => { await idbPut({ id: newId("ph"), pointId: pid, dataUrl: ev.target.result }); render(); };
        reader.readAsDataURL(f);
      }
    }
  };
};

/* ===== PDF & Signatures (Simplifi√©s) ===== */
const initSignatures = () => {
  ["sigControleur", "sigEntreprise", "sigClient"].forEach(id => {
    const canvas = byId(id), ctx = canvas.getContext("2d");
    const key = id.replace("sig", "").toLowerCase();
    if (state.chantier.signatures[key]) { 
      const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height); 
      img.src = state.chantier.signatures[key]; 
    }
    let drawing = false;
    canvas.onpointerdown = (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
    canvas.onpointermove = (e) => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }};
    canvas.onpointerup = () => { drawing = false; state.chantier.signatures[key] = canvas.toDataURL(); saveCurrentFiche(); };
    byId(`clear${id}`).onclick = () => { ctx.clearRect(0,0,canvas.width,canvas.height); state.chantier.signatures[key]=""; saveCurrentFiche(); };
  });
};

const exportPDF = async (action = "save") => {
  byId("pdfLoading").style.display = "flex";
  const container = document.createElement("div");
  container.style.width = "794px"; container.style.padding = "20px";
  container.innerHTML = `<h2>Rapport de R√©ception</h2><p>Projet : ${state.chantier.projet}</p>` + byId("pointsWrap").innerHTML;
  document.body.appendChild(container);

  const canvas = await html2canvas(container, { scale: 1.5 });
  const pdf = new jspdf.jsPDF();
  pdf.addImage(canvas.toDataURL("image/jpeg", 0.9), "JPEG", 5, 5, 200, (canvas.height*200)/canvas.width);
  
  const name = `PV_${state.chantier.commune || 'Chantier'}.pdf`;
  if (action === "share") {
    const file = new File([pdf.output("blob")], name, { type: "application/pdf" });
    if (navigator.share) await navigator.share({ files: [file], title: 'PV R√©ception' });
  } else pdf.save(name);

  container.remove(); byId("pdfLoading").style.display = "none";
};

/* ===== INIT ===== */
(async () => {
  let idx = loadFichesIndex();
  if (!idx.length) { const id = newId("f"); idx = [{ id, name: "Fiche 1", updatedAt: Date.now() }]; saveFichesIndex(idx); setCurrentFicheId(id); }
  const curId = getCurrentFicheId();
  const raw = localStorage.getItem(`FICHE_${curId}`);
  if (raw) state = JSON.parse(raw);

  handleEvents();
  byId("pdfBtn").onclick = () => exportPDF("save");
  byId("sharePdfBtn").onclick = () => exportPDF("share");
  
  // Fiches UI
  const sel = byId("ficheSelect");
  sel.onchange = () => { setCurrentFicheId(sel.value); location.reload(); };
  byId("newFicheBtn").onclick = () => { const id = newId("f"); setCurrentFicheId(id); localStorage.setItem(`FICHE_${id}`, JSON.stringify(emptyState())); location.reload(); };
  
  const refreshSel = () => { sel.innerHTML = loadFichesIndex().map(f => `<option value="${f.id}">${f.name}</option>`).join(""); sel.value = curId; };
  refreshSel(); await render(); initSignatures();
})();
</script>
</body>
</html>
