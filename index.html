<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R√©ception chantier ‚Äì Lampadaires solaires</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #f6f7f9; }
    header { padding: 16px; background: #111827; color: white; }
    main { padding: 16px; max-width: 980px; margin: 0 auto; }

    .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 720px){ .row { grid-template-columns: 1fr; } }

    label { display: block; font-size: 12px; color: #374151; margin-bottom: 4px; }
    input, select, textarea, button {
      width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #d1d5db; background: #fff;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea { min-height: 70px; resize: vertical; }

    .btnrow { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .btn { cursor:pointer; border: 0; background:#111827; color:white; padding:10px 12px; border-radius:10px; width:auto; }
    .btn.secondary { background:#374151; }
    .btn.danger { background:#b91c1c; }

    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; }
    .bad { background:#fee2e2; color:#991b1b; }

    .point-head { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap: wrap; }
    .small { font-size:12px; color:#6b7280; }

    .photos { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .thumb { width:110px; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff; }
    .thumb img { display:block; width:100%; height:80px; object-fit:cover; }
    .thumb div { font-size:11px; padding:6px; color:#374151; }

    /* ===== Overlay export PDF ===== */
    #pdfLoading {
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.85);
      color: white;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #pdfLoading .box { text-align: center; }
    #pdfLoading .spinner {
      width: 42px;
      height: 42px;
      border: 4px solid rgba(255,255,255,.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
<header>
  <div style="max-width:980px;margin:0 auto; display:flex; align-items:center; gap:14px;">
    <img src="logo.png" alt="Logo entreprise" style="height:48px; object-fit:contain;" />
    <div>
      <div style="font-weight:700;">R√©ception de chantier</div>
      <div class="small">Fiche des points non conformes</div>
    </div>
  </div>
</header>

<main>
  <!-- CHANTIER -->
  <section class="card" id="chantierCard">
    <h3 style="margin:0 0 10px 0;">1) Infos chantier</h3>

    <div class="row">
      <div>
        <label>Projet / Affaire</label>
        <input id="projet" placeholder="Ex: EP - Commune X - 2026" />
      </div>

      <div>
        <label>Commune</label>
        <input id="commune" placeholder="Ex: N√©rac" />
      </div>

      <div>
        <label>Adresse / Zone</label>
        <input id="zone" placeholder="Ex: Rue X" />
      </div>

      <div>
        <label>Date</label>
        <input id="date" type="date" />
      </div>

      <div>
        <label>Poseur</label>
        <select id="poseur">
          <option value="">‚Äî S√©lectionner ‚Äî</option>
          <option value="ELECTROMONTAGE">ELECTROMONTAGE</option>
          <option value="SPIE">SPIE</option>
          <option value="BYES">BYES</option>
          <option value="INEO">INEO</option>
          <option value="__autre__">Autre‚Ä¶</option>
        </select>
      </div>

      <div id="poseurAutreWrap" style="display:none;">
        <label>Nom du poseur</label>
        <input id="poseurAutre" placeholder="Saisir le nom" />
      </div>

      <div>
        <label>Chef d‚Äô√©quipe</label>
        <input id="chef" placeholder="Nom" />
      </div>

      <div>
        <label>Contr√¥leur</label>
        <select id="controleur">
          <option value="">‚Äî S√©lectionner ‚Äî</option>
          <option value="Neals Volante">Neals Volante</option>
          <option value="Tony Diniz">Tony Diniz</option>
          <option value="Quentin Gobbato">Quentin Gobbato</option>
          <option value="Virgil Delbrel">Virgil Delbrel</option>
          <option value="__autre__">Autre‚Ä¶</option>
        </select>
      </div>

      <div id="controleurAutreWrap" style="display:none;">
        <label>Nom du contr√¥leur</label>
        <input id="controleurAutre" placeholder="Saisir le nom" />
      </div>
    </div>

    <!-- MES FICHES -->
    <div class="row" style="margin-top:12px;">
      <div>
        <label>üìÇ Mes fiches</label>
        <select id="ficheSelect"></select>
        <div class="small" style="margin-top:6px;">Conseil : duplique une fiche ‚Äútype‚Äù, puis modifie.</div>
      </div>

      <div>
        <label>Actions fiche</label>
        <div class="btnrow">
          <button class="btn secondary" id="newFicheBtn" type="button">‚ûï Nouvelle</button>
          <button class="btn" id="saveFicheBtn" type="button">üíæ Sauver</button>
          <button class="btn secondary" id="dupFicheBtn" type="button">üìÑ Dupliquer</button>
          <button class="btn danger" id="delFicheBtn" type="button">üóëÔ∏è Supprimer</button>

          <!-- ‚úÖ NOUVEAU : Export / Import JSON (avec photos + signatures) -->
          <button class="btn secondary" id="exportJsonBtn" type="button">‚¨áÔ∏è Export JSON</button>
          <button class="btn secondary" id="importJsonBtn" type="button">‚¨ÜÔ∏è Import JSON</button>
          <input id="importJsonInput" type="file" accept="application/json" style="display:none;" />
        </div>
      </div>
    </div>

    <div class="btnrow" style="margin-top:12px;">
      <button class="btn" id="addPointBtn" type="button">‚ûï Ajouter un point non conforme</button>
      <button class="btn secondary" id="pdfBtn" type="button">üßæ Exporter PDF</button>
      <button class="btn danger" id="resetBtn" type="button">üßΩ Vider la fiche (courante)</button>
    </div>
  </section>

  <!-- POINTS -->
  <section id="pointsWrap"></section>

  <!-- SYNTHESE + SIGNATURES -->
  <section class="card" id="syntheseCard">
    <h3 style="margin:0 0 10px 0;">2) Synth√®se</h3>
    <div id="syntheseText" class="small"></div>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:14px 0;">

    <h4 style="margin:0 0 10px 0;">Signatures</h4>

    <div class="row">
      <div>
        <label>Contr√¥leur</label>
        <canvas id="sigControleur" width="420" height="160"
          style="border:1px solid #d1d5db;border-radius:10px;background:#fff; touch-action:none;"></canvas>
        <div class="btnrow" style="margin-top:8px;">
          <button class="btn danger" type="button" id="clearSigControleur">Effacer</button>
        </div>
      </div>

      <div>
        <label>Entreprise</label>
        <canvas id="sigEntreprise" width="420" height="160"
          style="border:1px solid #d1d5db;border-radius:10px;background:#fff; touch-action:none;"></canvas>
        <div class="btnrow" style="margin-top:8px;">
          <button class="btn danger" type="button" id="clearSigEntreprise">Effacer</button>
        </div>
      </div>

      <div>
        <label>Client</label>
        <canvas id="sigClient" width="420" height="160"
          style="border:1px solid #d1d5db;border-radius:10px;background:#fff; touch-action:none;"></canvas>
        <div class="btnrow" style="margin-top:8px;">
          <button class="btn danger" type="button" id="clearSigClient">Effacer</button>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Overlay -->
<div id="pdfLoading">
  <div class="box">
    <div class="spinner"></div>
    <div>G√©n√©ration du PDF‚Ä¶</div>
  </div>
</div>

<!-- html2canvas (global html2canvas) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- jsPDF UMD (global window.jspdf.jsPDF) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* =========================
   Stockage
   - Fiches (state) : localStorage (plusieurs fiches)
   - Photos : IndexedDB
========================= */

const LS_KEY_FALLBACK = "reception_lampadaire_state_fallback_v1"; // ancien fallback
const FICHES_INDEX_KEY = "FL_FICHES_INDEX_V1";
const CURRENT_FICHE_KEY = "FL_CURRENT_FICHE_ID_V1";

const DB_NAME = "reception_lampadaire_photos_v1";
const DB_STORE = "photos";

const byId = (id) => document.getElementById(id);
const ficheStorageKey = (id) => `FL_FICHE_${id}`;

const newId = (prefix="id") =>
  `${prefix}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;

const todayISO = () => {
  const d = new Date();
  const pad = (n) => String(n).padStart(2, "0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
};

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

const makeFicheLabel = (st) => {
  const proj = (st?.chantier?.projet || "").trim();
  const com = (st?.chantier?.commune || "").trim();
  const d = (st?.chantier?.date || "").trim();
  const base = [proj, com, d].filter(Boolean).join(" ‚Äî ");
  return base || "Fiche sans nom";
};

/* ===== IndexedDB helpers ===== */
const openDB = () => new Promise((resolve, reject) => {
  const req = indexedDB.open(DB_NAME, 1);
  req.onupgradeneeded = () => {
    const db = req.result;
    if (!db.objectStoreNames.contains(DB_STORE)) {
      const store = db.createObjectStore(DB_STORE, { keyPath: "id" });
      store.createIndex("pointId", "pointId", { unique:false });
    }
  };
  req.onsuccess = () => resolve(req.result);
  req.onerror = () => reject(req.error);
});

const idbPut = async (obj) => {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).put(obj);
    tx.oncomplete = () => { db.close(); resolve(true); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
};

const idbGetManyByPoint = async (pointId) => {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readonly");
    const idx = tx.objectStore(DB_STORE).index("pointId");
    const req = idx.getAll(pointId);
    req.onsuccess = () => { const r = req.result || []; db.close(); resolve(r); };
    req.onerror = () => { db.close(); reject(req.error); };
  });
};

const idbDelete = async (id) => {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).delete(id);
    tx.oncomplete = () => { db.close(); resolve(true); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
};

/* ===== Images: compression + resize ===== */
const compressImageToDataUrl = (file, opts = {}) => new Promise((resolve, reject) => {
  const { maxW = 1280, maxH = 1280, quality = 0.75, mime = "image/jpeg" } = opts;
  const img = new Image();
  const url = URL.createObjectURL(file);

  img.onload = () => {
    let w = img.width, h = img.height;
    const ratio = Math.min(maxW / w, maxH / h, 1);
    const nw = Math.max(1, Math.round(w * ratio));
    const nh = Math.max(1, Math.round(h * ratio));

    const canvas = document.createElement("canvas");
    canvas.width = nw; canvas.height = nh;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, nw, nh);
    URL.revokeObjectURL(url);

    try {
      resolve(canvas.toDataURL(mime, quality));
    } catch (e) { reject(e); }
  };
  img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
  img.src = url;
});

const waitForImages = (root) => {
  const imgs = Array.from(root.querySelectorAll("img"));
  return Promise.all(imgs.map(img => {
    if (img.complete && img.naturalWidth > 0) return Promise.resolve();
    return new Promise((res) => {
      img.onload = () => res();
      img.onerror = () => res();
    });
  }));
};

/* ===== Logo -> dataURL (fiable iPad PDF) ===== */
let LOGO_DATAURL_CACHE = "";
const getLogoDataUrl = async () => {
  if (LOGO_DATAURL_CACHE) return LOGO_DATAURL_CACHE;
  try {
    const res = await fetch("logo.png", { cache: "no-store" });
    const blob = await res.blob();
    const dataUrl = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(blob);
    });
    LOGO_DATAURL_CACHE = dataUrl;
    return dataUrl;
  } catch {
    return "logo.png";
  }
};

/* =========================
   State
========================= */
const defaultPoint = () => ({
  id: newId("pt"),
  numero: "",
  repere: "",
  lat: "",
  lon: "",
  reserves_txt: "",
  date_reprise: "",
});

const emptyState = () => ({
  chantier: {
    projet: "", commune: "", zone: "", date: todayISO(),
    poseur: "", poseurAutre: "",
    chef: "",
    controleur: "", controleurAutre: "",
    signatures: { controleur:"", entreprise:"", client:"" }
  },
  points: [ defaultPoint() ]
});

let state = emptyState();

const ensureSignatures = () => {
  state.chantier.signatures ||= { controleur:"", entreprise:"", client:"" };
  state.chantier.signatures.controleur ||= "";
  state.chantier.signatures.entreprise ||= "";
  state.chantier.signatures.client ||= "";
};

/* =========================
   Fiches (multi)
========================= */
const loadFichesIndex = () => {
  try { return JSON.parse(localStorage.getItem(FICHES_INDEX_KEY) || "[]"); }
  catch { return []; }
};
const saveFichesIndex = (arr) => localStorage.setItem(FICHES_INDEX_KEY, JSON.stringify(arr));
const getCurrentFicheId = () => localStorage.getItem(CURRENT_FICHE_KEY) || "";
const setCurrentFicheId = (id) => localStorage.setItem(CURRENT_FICHE_KEY, id);

/* ‚úÖ NEW: rebuild index si vide (robustesse) */
const rebuildIndexFromLocalStorage = () => {
  const keys = Object.keys(localStorage);
  const ids = keys
    .filter(k => k.startsWith("FL_FICHE_"))
    .map(k => k.replace("FL_FICHE_", ""));

  const index = [];
  for (const id of ids) {
    try {
      const st = JSON.parse(localStorage.getItem(ficheStorageKey(id)) || "null");
      if (!st?.chantier || !Array.isArray(st?.points)) continue;
      index.push({ id, name: makeFicheLabel(st), updatedAt: Date.now() });
    } catch {}
  }
  if (index.length) saveFichesIndex(index);
  return index;
};

const ensureAtLeastOneFiche = () => {
  let index = loadFichesIndex();
  if (!index.length) index = rebuildIndexFromLocalStorage();

  if (!index.length) {
    const id = newId("fiche");
    index = [{ id, name: makeFicheLabel(state), updatedAt: Date.now() }];
    saveFichesIndex(index);
    setCurrentFicheId(id);
    localStorage.setItem(ficheStorageKey(id), JSON.stringify(state));
  }

  if (!getCurrentFicheId()) setCurrentFicheId(index[0].id);
};

const refreshFicheSelect = () => {
  const sel = byId("ficheSelect");
  const index = loadFichesIndex().sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0));
  const cur = getCurrentFicheId();

  sel.innerHTML = index
    .map(f => `<option value="${f.id}">${escapeHtml(f.name || "Fiche")}</option>`)
    .join("");

  sel.value = cur || (index[0]?.id || "");
};

const loadFiche = async (id) => {
  const raw = localStorage.getItem(ficheStorageKey(id));
  if (!raw) return false;
  try {
    const parsed = JSON.parse(raw);
    if (parsed && parsed.chantier && Array.isArray(parsed.points)) {
      state = parsed;
      ensureSignatures();
      setCurrentFicheId(id);
      await render();
      initSignatures(true);
      return true;
    }
  } catch {}
  return false;
};

const saveCurrentFiche = () => {
  const id = getCurrentFicheId();
  if (!id) return;

  localStorage.setItem(ficheStorageKey(id), JSON.stringify(state));

  const index = loadFichesIndex();
  const name = makeFicheLabel(state);

  const next = index.map(f => f.id === id ? { ...f, name, updatedAt: Date.now() } : f);
  saveFichesIndex(next);
  refreshFicheSelect();
};

/* ===== Save / Load fallback ===== */
const saveState = () => {
  try {
    localStorage.setItem(LS_KEY_FALLBACK, JSON.stringify(state)); // fallback
    saveCurrentFiche();
    return true;
  } catch (e) {
    alert("‚ö†Ô∏è Impossible de sauvegarder. D√©tail : " + (e?.message || e));
    return false;
  }
};

const loadState = () => {
  // 1) fiche courante
  const cur = getCurrentFicheId();
  if (cur) {
    const raw = localStorage.getItem(ficheStorageKey(cur));
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        if (parsed && parsed.chantier && Array.isArray(parsed.points)) {
          state = parsed;
          return;
        }
      } catch {}
    }
  }

  // 2) fallback
  const rawOld = localStorage.getItem(LS_KEY_FALLBACK);
  if (rawOld) {
    try {
      const parsed = JSON.parse(rawOld);
      if (parsed && parsed.chantier && Array.isArray(parsed.points)) state = parsed;
    } catch {}
  }
};

const duplicateFicheWithPhotos = async () => {
  const index = loadFichesIndex();
  const srcId = getCurrentFicheId();
  if (!srcId) return;

  const srcState = JSON.parse(JSON.stringify(state));
  const newFicheId = newId("fiche");
  const mapping = new Map();

  const newPoints = (srcState.points || []).map(pt => {
    const newPointId = newId("pt");
    mapping.set(pt.id, newPointId);
    return { ...pt, id: newPointId };
  });

  const newState = {
    ...srcState,
    chantier: { ...srcState.chantier },
    points: newPoints
  };

  // dupliquer photos
  for (const [oldPid, newPid] of mapping.entries()) {
    const oldPhotos = await idbGetManyByPoint(oldPid);
    for (const ph of oldPhotos) {
      await idbPut({
        id: newId("ph"),
        pointId: newPid,
        dataUrl: ph.dataUrl,
        createdAt: Date.now()
      });
    }
  }

  localStorage.setItem(ficheStorageKey(newFicheId), JSON.stringify(newState));

  const name = makeFicheLabel(newState) + " (copie)";
  const nextIndex = [...index, { id: newFicheId, name, updatedAt: Date.now() }];
  saveFichesIndex(nextIndex);

  setCurrentFicheId(newFicheId);
  state = newState;
  ensureSignatures();
  await render();
  initSignatures(true);
  refreshFicheSelect();
};

/* ‚úÖ NEW: Export / Import JSON (state + photos + signatures) */
const exportCurrentFicheToJson = async () => {
  const ficheId = getCurrentFicheId();
  if (!ficheId) return;

  const photos = [];
  for (const pt of state.points || []) {
    const phs = await idbGetManyByPoint(pt.id);
    for (const ph of phs) photos.push(ph);
  }

  const payload = {
    meta: { exportedAt: new Date().toISOString(), version: 1 },
    state,
    photos
  };

  const blob = new Blob([JSON.stringify(payload)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `fiche_${makeFicheLabel(state).replaceAll(" ", "_").slice(0,60)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(() => URL.revokeObjectURL(url), 30000);
};

const importFicheFromJsonFile = async (file) => {
  const text = await file.text();
  const payload = JSON.parse(text);

  if (!payload?.state?.chantier || !Array.isArray(payload?.state?.points)) {
    alert("Fichier JSON invalide.");
    return;
  }

  const newFicheId = newId("fiche");
  const importedState = payload.state;

  // √©viter collisions d‚ÄôIDs -> remapper points/photos
  const mapping = new Map();
  importedState.points = (importedState.points || []).map(pt => {
    const newPid = newId("pt");
    mapping.set(pt.id, newPid);
    return { ...pt, id: newPid };
  });

  const importedPhotos = Array.isArray(payload.photos) ? payload.photos : [];
  for (const ph of importedPhotos) {
    const newPointId = mapping.get(ph.pointId);
    if (!newPointId) continue;
    await idbPut({
      id: newId("ph"),
      pointId: newPointId,
      dataUrl: ph.dataUrl,
      createdAt: Date.now()
    });
  }

  localStorage.setItem(ficheStorageKey(newFicheId), JSON.stringify(importedState));

  const index = loadFichesIndex();
  index.push({ id: newFicheId, name: makeFicheLabel(importedState) + " (import)", updatedAt: Date.now() });
  saveFichesIndex(index);

  setCurrentFicheId(newFicheId);
  state = importedState;
  ensureSignatures();
  await render();
  initSignatures(true);
  refreshFicheSelect();
  alert("‚úÖ Fiche import√©e");
};

/* =========================
   Render
========================= */
const renderPoint = (p, idx, photos) => {
  const numeroStyle = String(p.numero || "").trim() ? "" : "border:2px solid #ef4444;";

  return `
    <section class="card" data-point-id="${p.id}">
      <div class="point-head">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
          <strong>Point ${idx+1}</strong>
          <span class="pill bad">Non conforme</span>
          <span class="small">ID: ${p.id.slice(0,8)}</span>
        </div>
        <div class="btnrow">
          <button class="btn secondary" type="button" data-action="gps">üìç GPS</button>
          <button class="btn danger" type="button" data-action="remove">üóëÔ∏è Supprimer</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>N¬∞ point lumineux (obligatoire)</label>
          <input style="${numeroStyle}" value="${escapeHtml(p.numero)}" data-k="numero" placeholder="Ex: PL-12 / A22" />
        </div>
        <div>
          <label>Adresse / rep√®re</label>
          <input value="${escapeHtml(p.repere)}" data-k="repere" placeholder="Ex: devant maison 24" />
        </div>
        <div>
          <label>Latitude</label>
          <input value="${escapeHtml(p.lat)}" data-k="lat" placeholder="Auto via bouton GPS" />
        </div>
        <div>
          <label>Longitude</label>
          <input value="${escapeHtml(p.lon)}" data-k="lon" placeholder="Auto via bouton GPS" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <label>Date de reprise</label>
          <input type="date" value="${escapeHtml(p.date_reprise || "")}" data-k="date_reprise" />
        </div>
        <div></div>
      </div>

      <h4 style="margin:14px 0 8px 0;">Commentaire / non-conformit√©</h4>
      <textarea data-k="reserves_txt" placeholder="Observations, anomalies‚Ä¶">${escapeHtml(p.reserves_txt)}</textarea>

      <h4 style="margin:14px 0 8px 0;">Photos</h4>
      <input type="file" accept="image/*" multiple data-action="addPhotos" />
      <div class="small">Photos stock√©es localement (IndexedDB) + compress√©es</div>

      <div class="photos">
        ${(photos || []).map((ph, i) => `
          <div class="thumb">
            <img src="${ph.dataUrl}" alt="photo" />
            <div>
              Photo ${i+1}
              <button class="btn danger" type="button"
                style="margin-top:6px;padding:6px 8px;font-size:12px;"
                data-action="rmPhoto" data-photo-id="${ph.id}">Suppr.</button>
            </div>
          </div>
        `).join("")}
      </div>
    </section>
  `;
};

const render = async () => {
  byId("projet").value = state.chantier.projet || "";
  byId("commune").value = state.chantier.commune || "";
  byId("zone").value = state.chantier.zone || "";
  byId("date").value = state.chantier.date || todayISO();

  byId("poseur").value = state.chantier.poseur || "";
  byId("poseurAutre").value = state.chantier.poseurAutre || "";
  byId("poseurAutreWrap").style.display =
    (state.chantier.poseur === "__autre__") ? "block" : "none";

  byId("chef").value = state.chantier.chef || "";

  byId("controleur").value = state.chantier.controleur || "";
  byId("controleurAutre").value = state.chantier.controleurAutre || "";
  byId("controleurAutreWrap").style.display =
    (state.chantier.controleur === "__autre__") ? "block" : "none";

  // charge photos par point
  const chunks = [];
  for (let i=0; i<state.points.length; i++){
    const p = state.points[i];
    const photos = await idbGetManyByPoint(p.id);
    chunks.push(renderPoint(p, i, photos));
  }
  byId("pointsWrap").innerHTML = chunks.join("");

  byId("syntheseText").innerHTML = `
    <div>Points non conformes : <strong>${state.points.length}</strong></div>
  `;
};

/* =========================
   Bind chantier
========================= */
const bindChantier = () => {
  const map = [
    ["projet","projet"], ["commune","commune"], ["zone","zone"], ["date","date"],
    ["poseur","poseur"], ["chef","chef"],
    ["controleur","controleur"],
  ];

  map.forEach(([id, key]) => {
    const el = byId(id);
    if (!el) return;

    const apply = async () => {
      state.chantier[key] = el.value;
      saveState();
      await render();
    };

    el.addEventListener("input", apply);
    el.addEventListener("change", apply);
  });

  // Controleur - autre
  const ctrlSelect = byId("controleur");
  const ctrlOtherWrap = byId("controleurAutreWrap");
  const ctrlOtherInput = byId("controleurAutre");

  ctrlSelect.addEventListener("change", async () => {
    const isOther = ctrlSelect.value === "__autre__";
    ctrlOtherWrap.style.display = isOther ? "block" : "none";
    if (!isOther) {
      state.chantier.controleurAutre = "";
      ctrlOtherInput.value = "";
      saveState();
      await render();
    }
  });

  ctrlOtherInput.addEventListener("input", () => {
    state.chantier.controleurAutre = ctrlOtherInput.value;
    saveState();
  });

  // Poseur - autre
  const poseurSelect = byId("poseur");
  const poseurOtherWrap = byId("poseurAutreWrap");
  const poseurOtherInput = byId("poseurAutre");

  poseurSelect.addEventListener("change", async () => {
    const isOther = poseurSelect.value === "__autre__";
    poseurOtherWrap.style.display = isOther ? "block" : "none";
    if (!isOther) {
      state.chantier.poseurAutre = "";
      poseurOtherInput.value = "";
      saveState();
      await render();
    }
  });

  poseurOtherInput.addEventListener("input", () => {
    state.chantier.poseurAutre = poseurOtherInput.value;
    saveState();
  });
};

/* =========================
   Points events
========================= */
const handlePointsEvents = () => {
  const wrap = byId("pointsWrap");

  wrap.addEventListener("input", (e) => {
    const card = e.target.closest("[data-point-id]");
    if (!card) return;

    const pid = card.getAttribute("data-point-id");
    const p = state.points.find(x => x.id === pid);
    if (!p) return;

    const k = e.target.getAttribute("data-k");
    if (!k) return;

    p[k] = e.target.value;
    saveState();
  });

  wrap.addEventListener("change", async (e) => {
    const card = e.target.closest("[data-point-id]");
    if (!card) return;

    const pid = card.getAttribute("data-point-id");
    const p = state.points.find(x => x.id === pid);
    if (!p) return;

    if (e.target.getAttribute("data-action") === "addPhotos") {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      const MAX_PHOTOS_PER_POINT = 12;
      const existing = await idbGetManyByPoint(pid);

      if (existing.length >= MAX_PHOTOS_PER_POINT) {
        alert("Limite atteinte : " + MAX_PHOTOS_PER_POINT + " photos max pour ce point.");
        e.target.value = "";
        return;
      }

      let remaining = MAX_PHOTOS_PER_POINT - existing.length;

      for (const f of files) {
        if (remaining <= 0) break;
        try {
          const dataUrl = await compressImageToDataUrl(f, { maxW: 1280, maxH: 1280, quality: 0.75 });
          await idbPut({ id: newId("ph"), pointId: pid, dataUrl, createdAt: Date.now() });
          remaining--;
        } catch (err) {
          alert("Impossible d'ajouter une photo : " + (err?.message || err));
        }
      }

      e.target.value = ""; // important iOS
      await render();
      saveState();
    }
  });

  wrap.addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;

    const card = btn.closest("[data-point-id]");
    if (!card) return;

    const pid = card.getAttribute("data-point-id");
    const action = btn.getAttribute("data-action");

    if (action === "gps") {
      const p = state.points.find(x => x.id === pid);
      if (!p) return;

      if (!navigator.geolocation) {
        alert("G√©olocalisation non disponible sur ce navigateur.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          p.lat = String(pos.coords.latitude);
          p.lon = String(pos.coords.longitude);
          saveState();
          await render();
        },
        (err) => alert("GPS indisponible. V√©rifie HTTPS + autorisation Safari. D√©tail : " + err.message),
        { enableHighAccuracy: true, timeout: 10000 }
      );
      return;
    }

    if (action === "remove") {
      if (state.points.length === 1) {
        alert("Il faut au moins 1 point dans la fiche.");
        return;
      }

      const photos = await idbGetManyByPoint(pid);
      for (const ph of photos) await idbDelete(ph.id);

      state.points = state.points.filter(x => x.id !== pid);
      saveState();
      await render();
      return;
    }

    if (action === "rmPhoto") {
      const photoId = btn.getAttribute("data-photo-id");
      if (!photoId) return;
      await idbDelete(photoId);
      await render();
      saveState();
      return;
    }
  });
};

/* =========================
   Signatures
========================= */
let sigCleanup = []; // pour √©viter accumulation listeners

const setupSignaturePad = (canvasId, clearBtnId, key) => {
  const canvas = byId(canvasId);
  const clearBtn = byId(clearBtnId);
  const ctx = canvas.getContext("2d");
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";

  // restore image
  const existing = state.chantier.signatures?.[key];
  if (existing) {
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.src = existing;
  } else {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  let drawing = false;

  const getPos = (ev) => {
    const rect = canvas.getBoundingClientRect();
    const clientX = ev.touches ? ev.touches[0].clientX : ev.clientX;
    const clientY = ev.touches ? ev.touches[0].clientY : ev.clientY;
    return {
      x: (clientX - rect.left) * (canvas.width / rect.width),
      y: (clientY - rect.top) * (canvas.height / rect.height)
    };
  };

  const start = (ev) => {
    ev.preventDefault();
    drawing = true;
    const p = getPos(ev);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  };

  const move = (ev) => {
    if (!drawing) return;
    ev.preventDefault();
    const p = getPos(ev);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  };

  const end = (ev) => {
    if (!drawing) return;
    ev.preventDefault();
    drawing = false;
    state.chantier.signatures[key] = canvas.toDataURL("image/png");
    saveState();
  };

  const onMouseUp = (ev) => end(ev);

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", onMouseUp);

  canvas.addEventListener("touchstart", start, { passive:false });
  canvas.addEventListener("touchmove", move, { passive:false });
  canvas.addEventListener("touchend", end, { passive:false });

  /* ‚úÖ FIX IMPORTANT : √©viter accumulation listeners sur bouton Effacer */
  const onClear = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    state.chantier.signatures[key] = "";
    saveState();
  };
  clearBtn.addEventListener("click", onClear);

  // cleanup handlers
  sigCleanup.push(() => {
    canvas.removeEventListener("mousedown", start);
    canvas.removeEventListener("mousemove", move);
    window.removeEventListener("mouseup", onMouseUp);
    canvas.removeEventListener("touchstart", start);
    canvas.removeEventListener("touchmove", move);
    canvas.removeEventListener("touchend", end);
    clearBtn.removeEventListener("click", onClear);
  });
};

const initSignatures = (force=false) => {
  ensureSignatures();
  if (force) {
    sigCleanup.forEach(fn => { try { fn(); } catch {} });
    sigCleanup = [];
  }
  setupSignaturePad("sigControleur", "clearSigControleur", "controleur");
  setupSignaturePad("sigEntreprise", "clearSigEntreprise", "entreprise");
  setupSignaturePad("sigClient", "clearSigClient", "client");
};

/* =========================
   PDF
========================= */
const buildPdfBody = async () => {
  const sigs = state.chantier.signatures || {};

  const controleurNom =
    state.chantier.controleur === "__autre__"
      ? (state.chantier.controleurAutre || "")
      : (state.chantier.controleur || "");

  const poseurNom =
    state.chantier.poseur === "__autre__"
      ? (state.chantier.poseurAutre || "")
      : (state.chantier.poseur || "");

  const logoSrc = await getLogoDataUrl();

  const rows = [];
  for (let i = 0; i < state.points.length; i++) {
    const p = state.points[i];
    const photos = await idbGetManyByPoint(p.id);
    const first3 = photos.slice(0, 3);

    rows.push(`
      <tr style="page-break-inside:avoid;">
        <td style="border:1px solid #ddd;padding:8px;vertical-align:top;">${i + 1}</td>
        <td style="border:1px solid #ddd;padding:8px;vertical-align:top;"><strong>${escapeHtml(p.numero)}</strong></td>
        <td style="border:1px solid #ddd;padding:8px;vertical-align:top;background:#fee2e2;color:#991b1b;font-weight:700;">
          ${escapeHtml(p.reserves_txt || "‚Äî")}
        </td>
        <td style="border:1px solid #ddd;padding:8px;vertical-align:top;">
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            ${first3.map(ph => `
              <img src="${ph.dataUrl}" alt="Photo"
                style="height:85px;width:auto;object-fit:cover;border:1px solid #ddd;border-radius:6px;">
            `).join("")}
            ${(photos.length > 3) ? `<div style="font-size:11px;color:#555;align-self:center;">+${photos.length - 3}</div>` : ""}
          </div>
        </td>
        <td style="border:1px solid #ddd;padding:8px;vertical-align:top;">
          ${escapeHtml(p.repere || "")}<br>
          <span style="font-size:11px;color:#555;">
            ${escapeHtml(p.lat || "")} ${(p.lat && p.lon) ? " ‚Ä¢ " : ""} ${escapeHtml(p.lon || "")}
          </span>
        </td>
        <td style="border:1px solid #ddd;padding:8px;vertical-align:top;white-space:nowrap;">${escapeHtml(p.date_reprise || "")}</td>
      </tr>
    `);
  }

  const signatureBox = (imgDataUrl) => {
    if (imgDataUrl) {
      return `<img src="${imgDataUrl}" style="width:100%;max-height:140px;object-fit:contain;border:1px solid #ddd;border-radius:8px;">`;
    }
    return `
      <div style="width:100%;height:120px;border:2px solid #111;border-radius:8px;"></div>
      <div style="font-size:11px;color:#555;margin-top:6px;text-align:center;">Nom / Date / Signature</div>
    `;
  };

  return `
    <div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.35;">
      <div style="display:flex;gap:14px;align-items:center;border-bottom:2px solid #111827;padding-bottom:10px;margin-bottom:16px;">
        <img src="${logoSrc}" alt="Logo" style="height:80px;width:auto;object-fit:contain;">
        <div>
          <div style="font-size:18px;font-weight:700;margin:0;">PV ‚Äì Points non conformes (R√©serves)</div>
          <div style="font-size:12px;color:#555;margin-top:4px;">
            Commune : <strong>${escapeHtml(state.chantier.commune)}</strong> |
            Date : <strong>${escapeHtml(state.chantier.date)}</strong><br>
            Projet : <strong>${escapeHtml(state.chantier.projet)}</strong><br>
            Poseur : <strong>${escapeHtml(poseurNom)}</strong> |
            Contr√¥leur : <strong>${escapeHtml(controleurNom)}</strong>
          </div>
        </div>
      </div>

      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead>
          <tr>
            <th style="border:1px solid #ddd;padding:8px;background:#f3f4f6;text-align:left;width:4%;">#</th>
            <th style="border:1px solid #ddd;padding:8px;background:#f3f4f6;text-align:left;width:10%;">N¬∞ point</th>
            <th style="border:1px solid #ddd;padding:8px;background:#f3f4f6;text-align:left;width:40%;">Non-conformit√© / Observation</th>
            <th style="border:1px solid #ddd;padding:8px;background:#f3f4f6;text-align:left;width:16%;">Photos</th>
            <th style="border:1px solid #ddd;padding:8px;background:#f3f4f6;text-align:left;width:18%;">Localisation</th>
            <th style="border:1px solid #ddd;padding:8px;background:#f3f4f6;text-align:left;width:12%;">Date de reprise</th>
          </tr>
        </thead>
        <tbody>
          ${rows.join("")}
        </tbody>
      </table>

      <h2 style="margin-top:16px;">Signatures</h2>
      <table style="width:100%;border-collapse:collapse;">
        <tr>
          <td style="width:33%;padding:8px;border:1px solid #ddd;">
            <strong>Contr√¥leur</strong><br>
            ${signatureBox(sigs.controleur)}
          </td>
          <td style="width:33%;padding:8px;border:1px solid #ddd;">
            <strong>Entreprise</strong><br>
            ${signatureBox(sigs.entreprise)}
          </td>
          <td style="width:33%;padding:8px;border:1px solid #ddd;">
            <strong>Client</strong><br>
            ${signatureBox(sigs.client)}
          </td>
        </tr>
      </table>
    </div>
  `;
};

const exportPDF = async () => {
  let container = null;

  try {
    // 1. Validation minimum
    const missing = state.points
      .map((p, i) => (!String(p.numero || "").trim() ? `Point ${i+1}` : null))
      .filter(Boolean);
    if (missing.length) {
      alert("Num√©ro obligatoire manquant pour : " + missing.join(", "));
      return; // On ne lance pas la g√©n√©ration si invalide
    }

    byId("pdfLoading").style.display = "flex";

    // 2. Container de rendu
    container = document.createElement("div");
    // CORRECTION iOS : On sort l'√©l√©ment de l'√©cran au lieu de le rendre "hidden"
    container.style.position = "absolute"; 
    container.style.left = "-9999px"; 
    container.style.top = "0";
    container.style.width = "794px";
    container.style.background = "#fff";
    container.style.zIndex = "9999";

    container.innerHTML = await buildPdfBody();
    document.body.appendChild(container);

    // 3. Attendre le rendu visuel et les images
    await new Promise(r => requestAnimationFrame(r));
    await new Promise(r => requestAnimationFrame(r));
    if (document.fonts && document.fonts.ready) {
      try { await document.fonts.ready; } catch(e) {}
    }
    await waitForImages(container);
    await new Promise(r => setTimeout(r, 150));

    // 4. Capture Canvas
    const canvas = await html2canvas(container, {
      scale: 1.3,
      useCORS: true,
      allowTaint: false,
      backgroundColor: "#ffffff",
      logging: false,
      imageTimeout: 20000
    });

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: "mm", format: "a4", orientation: "portrait" });

    const pdfW = pdf.internal.pageSize.getWidth();
    const pdfH = pdf.internal.pageSize.getHeight();
    const M = 8;
    const usableW = pdfW - 2 * M;
    const usableH = pdfH - 2 * M;

    const imgW = usableW;
    const imgH = canvas.height * (imgW / canvas.width);

    // Logique de pagination
    if (imgH <= usableH) {
      const imgData = canvas.toDataURL("image/jpeg", 0.90);
      pdf.addImage(imgData, "JPEG", M, M, imgW, imgH);
    } else {
      const pageCanvas = document.createElement("canvas");
      const pageCtx = pageCanvas.getContext("2d");

      const pageHpx = Math.floor(canvas.width * (usableH / usableW));
      let y = 0;
      let first = true;

      while (y < canvas.height) {
        const sliceH = Math.min(pageHpx, canvas.height - y);
        pageCanvas.width = canvas.width;
        pageCanvas.height = sliceH;
        pageCtx.clearRect(0, 0, pageCanvas.width, pageCanvas.height);
        pageCtx.drawImage(canvas, 0, y, canvas.width, sliceH, 0, 0, pageCanvas.width, sliceH);

        const pageImg = pageCanvas.toDataURL("image/jpeg", 0.90);
        const pageImgH_mm = (sliceH * imgW) / canvas.width;

        if (!first) pdf.addPage();
        first = false;

        pdf.addImage(pageImg, "JPEG", M, M, imgW, pageImgH_mm);
        y += sliceH;
      }
    }

    byId("pdfLoading").style.display = "none";

    // 5. CORRECTION iOS : Enregistrement et partage
    const blob = pdf.output("blob");
    const projName = state.chantier.projet || "Chantier";
    const fileName = `Audit_${projName}.pdf`.replace(/[^a-z0-9_-]/gi, '_');
    const file = new File([blob], fileName, { type: 'application/pdf' });

    // Si on est sur iPad/iOS et que le partage de fichier est support√©
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({
          files: [file],
          title: 'Export PDF',
          text: 'Voici la fiche PDF de la r√©ception de chantier.'
        });
      } catch (err) {
        console.log("Partage annul√© ou √©chou√©", err);
      }
    } else {
      // Fallback pour PC classiques
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 60000);
    }

  } catch (e) {
    byId("pdfLoading").style.display = "none";
    alert("Erreur PDF : " + (e?.message || e));
  } finally {
    if (container) container.remove();
  }
};

/* =========================
   Buttons
========================= */
const bindButtons = () => {
  byId("addPointBtn").addEventListener("click", async () => {
    state.points.push(defaultPoint());
    saveState();
    await render();
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  });

  byId("pdfBtn").addEventListener("click", exportPDF);

  // vider la fiche courante (sans toucher les autres fiches)
  byId("resetBtn").addEventListener("click", async () => {
    if (!confirm("Vider la fiche courante ? (points + photos + signatures)")) return;

    // supprimer photos des points
    for (const pt of (state.points || [])) {
      const photos = await idbGetManyByPoint(pt.id);
      for (const ph of photos) await idbDelete(ph.id);
    }

    // reset state
    state = emptyState();

    saveState();
    await render();
    initSignatures(true);
  });
};

/* =========================
   UI Fiches
========================= */
const bindFichesUI = () => {
  const sel = byId("ficheSelect");

  sel.addEventListener("change", async () => {
    const id = sel.value;
    if (!id) return;
    await loadFiche(id);
    refreshFicheSelect();
  });

  byId("saveFicheBtn").addEventListener("click", async () => {
    saveState();
    refreshFicheSelect();
    alert("‚úÖ Fiche sauvegard√©e");
  });

  byId("newFicheBtn").addEventListener("click", async () => {
    const id = newId("fiche");
    state = emptyState();
    localStorage.setItem(ficheStorageKey(id), JSON.stringify(state));

    const index = loadFichesIndex();
    index.push({ id, name: "Nouvelle fiche", updatedAt: Date.now() });
    saveFichesIndex(index);

    setCurrentFicheId(id);
    ensureSignatures();
    await render();
    initSignatures(true);
    refreshFicheSelect();
  });

  byId("dupFicheBtn").addEventListener("click", async () => {
    await duplicateFicheWithPhotos();
    alert("‚úÖ Fiche dupliqu√©e (photos incluses)");
  });

  byId("delFicheBtn").addEventListener("click", async () => {
    const id = getCurrentFicheId();
    if (!id) return;

    if (!confirm("Supprimer cette fiche ? (photos incluses)")) return;

    // supprimer photos de cette fiche
    try {
      const raw = localStorage.getItem(ficheStorageKey(id));
      if (raw) {
        const st = JSON.parse(raw);
        for (const pt of (st?.points || [])) {
          const photos = await idbGetManyByPoint(pt.id);
          for (const ph of photos) await idbDelete(ph.id);
        }
      }
    } catch {}

    localStorage.removeItem(ficheStorageKey(id));
    let index = loadFichesIndex().filter(f => f.id !== id);
    saveFichesIndex(index);

    if (!index.length) {
      state = emptyState();
      ensureAtLeastOneFiche();
    } else {
      setCurrentFicheId(index[0].id);
      await loadFiche(index[0].id);
    }

    refreshFicheSelect();
    alert("üóëÔ∏è Fiche supprim√©e");
  });

  /* ‚úÖ NEW: export/import */
  byId("exportJsonBtn").addEventListener("click", exportCurrentFicheToJson);

  const fileInput = byId("importJsonInput");
  byId("importJsonBtn").addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", async () => {
    const f = fileInput.files?.[0];
    if (!f) return;
    try {
      await importFicheFromJsonFile(f);
    } catch (e) {
      alert("Import impossible : " + (e?.message || e));
    } finally {
      fileInput.value = "";
    }
  });
};

/* =========================
   Init
========================= */
(async () => {
  loadState();
  ensureAtLeastOneFiche();
  ensureSignatures();

  bindChantier();
  handlePointsEvents();
  bindButtons();
  bindFichesUI();

  refreshFicheSelect();
  await render();
  saveState();
  initSignatures(true);
})();
</script>
</body>
</html>
